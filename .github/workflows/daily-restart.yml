name: Daily Server Restart (DEPRECATED)

# NOTE: This workflow is deprecated. Server restarts are now handled by the Discord bot
# via src/cogs/serverRestart.js which provides:
# - Daily restart at 12:00 AM CST (6:00 AM UTC)
# - In-game countdown warnings
# - Discord DM notifications on success/failure
# - Manual /restart command for admins
#
# This workflow is kept as a backup and can be triggered manually if needed.

on:
  # Disabled automatic schedule - bot handles this now
  # schedule:
  #   - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI as backup

jobs:
  restart-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install rcon-client

      - name: Send restart command via RCON
        env:
          RCON_HOST: ${{ secrets.RCON_HOST }}
          RCON_PORT: ${{ secrets.RCON_PORT }}
          RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
        run: |
          node -e "
          const { Rcon } = require('rcon-client');

          async function restartServer() {
            const host = process.env.RCON_HOST;
            const port = parseInt(process.env.RCON_PORT) || 25575;
            const password = process.env.RCON_PASSWORD;

            if (!host || !password) {
              console.error('RCON credentials not configured');
              process.exit(1);
            }

            let rcon = null;

            try {
              console.log('Connecting to RCON at ' + host + ':' + port);
              
              rcon = await Rcon.connect({
                host: host,
                port: port,
                password: password,
                timeout: 10000
              });

              // Send warning messages before restart
              console.log('Sending restart warnings...');
              await rcon.send('broadcast &c[Server] &fRestarting in 30 seconds for scheduled maintenance!');
              await new Promise(r => setTimeout(r, 10000));
              
              await rcon.send('broadcast &c[Server] &fRestarting in 20 seconds!');
              await new Promise(r => setTimeout(r, 10000));
              
              await rcon.send('broadcast &c[Server] &fRestarting in 10 seconds!');
              await new Promise(r => setTimeout(r, 5000));
              
              await rcon.send('broadcast &c[Server] &fRestarting in 5 seconds!');
              await new Promise(r => setTimeout(r, 3000));
              
              await rcon.send('broadcast &c[Server] &fRestarting in 2 seconds!');
              await new Promise(r => setTimeout(r, 2000));

              // Send restart command
              console.log('Sending restart command...');
              const response = await rcon.send('restart');
              console.log('Restart response:', response);

              await rcon.end();
              console.log('Server restart initiated successfully');
              
            } catch (error) {
              console.error('RCON Error:', error.message);
              
              if (rcon) {
                try {
                  await rcon.end();
                } catch (e) {}
              }
              
              process.exit(1);
            }
          }

          restartServer();
          "

      - name: Log restart time
        run: |
          echo "Server restart initiated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Local time (CST): $(TZ='America/Chicago' date '+%Y-%m-%d %H:%M:%S %Z')"
