name: Set Bot Version

on:
  push:
    # change this to the branch you deploy from
    branches: [ main ]

jobs:
  set-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: ver
        run: |
          VERSION=""
          if [ -f package.json ]; then
            VERSION=$(jq -r .version package.json 2>/dev/null || true)
          fi
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            VERSION=${GITHUB_SHA::7}
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update Pterodactyl BOT_VERSION
        env:
          PANEL_URL: "https://panel.newlifesmp.com"
          API_KEY: ${{ secrets.PTERODACTYL_API_KEY }}
          SERVER_ID: "0b7ac013-ba3f-40f7-bd16-d3cf448461fe"
          BOT_VERSION: ${{ steps.ver.outputs.version }}
        run: |
          if [ -z "$API_KEY" ]; then
            echo "Missing PTERODACTYL_API_KEY secret"
            exit 1
          fi

          echo "Setting BOT_VERSION=$BOT_VERSION on server $SERVER_ID"

          # Use Pterodactyl Client API to update startup variable
          # First, get the list of startup variables to find BOT_VERSION's env_variable key
          VARS=$(curl -s -H "Authorization: Bearer $API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "$PANEL_URL/api/client/servers/$SERVER_ID/startup")

          # Find the BOT_VERSION variable key
          VAR_KEY=$(echo "$VARS" | jq -r '.data[] | select(.attributes.env_variable == "BOT_VERSION") | .attributes.env_variable' 2>/dev/null || echo "BOT_VERSION")

          if [ -z "$VAR_KEY" ]; then
            VAR_KEY="BOT_VERSION"
          fi

          # Update the startup variable via Client API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "Authorization: Bearer $API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d "{\"key\": \"BOT_VERSION\", \"value\": \"$BOT_VERSION\"}" \
            "$PANEL_URL/api/client/servers/$SERVER_ID/startup/variable")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Successfully updated BOT_VERSION to $BOT_VERSION"
          else
            echo "❌ Failed to update (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Done
        run: echo "Pterodactyl BOT_VERSION set to ${{ steps.ver.outputs.version }}"
