<%- include('partials/header', {user: user, isAdmin: true}) %>
  <div class="content-container">
    <div class="page-hero">
      <h1>ðŸŽ­ Reaction Roles</h1>
      <p class="intro-text">Configure self-assignable roles via button reactions</p>
    </div>

    <!-- Create New Message -->
    <div class="card">
      <div class="card-header">
        <h3>âž• Create Reaction Role Message</h3>
      </div>
      <div class="card-body">
        <form action="/admin/reactionroles/create" method="POST" class="rr-form">
          <div class="form-group">
            <label for="channelId">Channel ID *</label>
            <input type="text" name="channelId" id="channelId" required placeholder="1234567890123456789">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="title">Embed Title *</label>
              <input type="text" name="title" id="title" required placeholder="ðŸŽ­ Role Selection">
            </div>
            <div class="form-group small">
              <label for="color">Color</label>
              <input type="color" name="color" id="color" value="#3b82f6">
            </div>
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <textarea name="description" id="description" rows="3" placeholder="Click a button below to get or remove a role!"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Create Message</button>
        </form>
      </div>
    </div>

    <!-- Existing Reaction Role Messages -->
    <div class="table-section">
      <h3>ðŸ“¦ Active Reaction Role Messages <span class="count"><%= Object.keys(messages || {}).length %></span></h3>
      <div class="table-container">
        <% if (Object.keys(messages || {}).length === 0) { %>
          <div class="empty-state">
            <h4>No reaction role messages</h4>
            <p>Create your first reaction role message above, or use <code>/reactionroles create</code></p>
          </div>
        <% } else { %>
          <div class="rr-grid">
            <% Object.entries(messages).forEach(function([msgId, roles]) { %>
              <div class="rr-card">
                <div class="rr-header">
                  <span class="mono">Message: <%= msgId.substring(0, 12) %>...</span>
                  <span class="channel-tag"><#<%= roles[0]?.channelId || 'unknown' %>></span>
                </div>
                <div class="rr-roles">
                  <% roles.forEach(function(role) { %>
                    <div class="role-item">
                      <span class="role-emoji"><%= role.emoji %></span>
                      <span class="role-id">@<%= role.roleId.substring(0, 8) %>...</span>
                      <span class="role-label muted"><%= role.description || '' %></span>
                      <form action="/admin/reactionroles/remove" method="POST" style="display: inline; margin-left: auto;">
                        <input type="hidden" name="messageId" value="<%= msgId %>">
                        <input type="hidden" name="roleId" value="<%= role.roleId %>">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Remove this role?')">Ã—</button>
                      </form>
                    </div>
                  <% }) %>
                </div>
                <div class="rr-actions">
                  <button class="btn btn-sm btn-secondary" onclick="showAddRole('<%= msgId %>')">+ Add Role</button>
                  <form action="/admin/reactionroles/delete" method="POST" style="display: inline;">
                    <input type="hidden" name="messageId" value="<%= msgId %>">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete all roles from this message?')">Delete All</button>
                  </form>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Add Role Modal -->
    <div id="addRoleModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>âž• Add Role to Message</h3>
          <button onclick="closeModal()" class="btn btn-sm btn-secondary">Ã—</button>
        </div>
        <form action="/admin/reactionroles/add" method="POST">
          <input type="hidden" name="messageId" id="modalMessageId">
          <div class="form-group">
            <label for="roleId">Role ID *</label>
            <input type="text" name="roleId" id="roleId" required placeholder="1234567890123456789">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="emoji">Emoji *</label>
              <input type="text" name="emoji" id="emoji" required placeholder="ðŸŽ®">
            </div>
            <div class="form-group">
              <label for="label">Label</label>
              <input type="text" name="label" id="label" placeholder="Role name">
            </div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">Add Role</button>
            <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    .rr-form {
      max-width: 500px;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: var(--text-primary);
    }
    .form-group input[type="color"] {
      height: 42px;
      padding: 0.25rem;
    }
    .form-group.small {
      max-width: 100px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
    }
    
    .rr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1rem;
    }
    .rr-card {
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      overflow: hidden;
    }
    .rr-header {
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .channel-tag {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .rr-roles {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .role-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    .role-emoji {
      font-size: 1.25rem;
    }
    .role-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }
    .role-label {
      font-size: 0.85rem;
      flex: 1;
    }
    .rr-actions {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 0.5rem;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 0;
      max-width: 450px;
      width: 90%;
    }
    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
    }
    .modal-content form {
      padding: 1.5rem;
    }
    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
  </style>

  <script>
    function showAddRole(messageId) {
      document.getElementById('modalMessageId').value = messageId;
      document.getElementById('addRoleModal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('addRoleModal').style.display = 'none';
    }
  </script>
<%- include('partials/footer') %>
